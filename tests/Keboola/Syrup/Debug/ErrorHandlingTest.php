<?php
/**
 * Created by PhpStorm.
 * User: miroslavcillik
 * Date: 24/02/16
 * Time: 14:30
 */

namespace Keboola\Syrup\Tests\Debug;

use Keboola\Syrup\Test\WebTestCase;
use Monolog\Handler\TestHandler;
use Monolog\Logger;
use Monolog\Processor\PsrLogMessageProcessor;
use Symfony\Bundle\FrameworkBundle\Client;

class ErrorHandlingTest extends WebTestCase
{
    /** @var Client */
    private $client;

    protected $testPerformed = false;

    public function testControllerNoticeToException()
    {
        $this->client = $this->createClient();

        $errorOccured = false;

        $stdoutProcessorMock = $this->getMockBuilder('Keboola\\Syrup\\Monolog\\Processor\\StdoutProcessor')
            ->disableOriginalConstructor()
            ->getMock();
        $stdoutProcessorMock->expects($this->any())
            ->method("processRecord")
            ->with($this->callback(function ($subject) use (&$errorOccured) {
                if ($subject['message'] == 'Notice: Undefined offset: 3') {
                    $e = $subject['context']['exception'];
                    $errorOccured = true;
                    return ($e instanceof \Symfony\Component\Debug\Exception\ContextErrorException);
                }
                return true;
            }))
            ->willReturn([
                'level' => 100,
                'message' => 'dummy',
            ]);

        $container = $this->client->getContainer();
        $container->set('syrup.monolog.stdout_processor', $stdoutProcessorMock);

        $this->client->request('GET', '/tests/notice');
        $response = $this->client->getResponse();
        $responseJson = json_decode($response->getContent(), true);

        $this->assertEquals('error', $responseJson['status']);
        $this->assertEquals('Application error', $responseJson['error']);
        $this->assertEquals(500, $responseJson['code']);
        $this->assertArrayHasKey('exceptionId', $responseJson);
        $this->assertArrayHasKey('runId', $responseJson);
        $this->assertTrue($errorOccured);
    }

    public function testLoggerContextReplacement()
    {
        $this->client = $this->createClient();

        $container = $this->client->getContainer();
        /** @var Logger $logger */
        $logger = $container->get('logger');
        $handler = new TestHandler();
        $handler->pushProcessor(new PsrLogMessageProcessor());
        $logger->pushHandler($handler);
        $logger->info(
            str_repeat('a {bar} very long message with braces inside and even more longer replacement ', 200),
            ['bar' => 'foo']
        );
        $records = $handler->getRecords();
        $this->assertCount(1, $records);
        $this->assertEquals(
            'a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement a foo very long message with braces inside and even more longer replacement ',
            $records[0]['message']
        );
        $this->assertEquals(
            'INFO',
            $records[0]['level_name']
        );
    }
}
